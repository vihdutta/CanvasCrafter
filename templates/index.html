<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CanvasCrafter</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Montserrat Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"/>
  <script>
    tailwindConfig = {
      theme: {
        extend: {
          colors: {
            'umich-blue': '#00274c',
            'umich-maize': '#ffcb05',
            'canvas-blue': '#0374B5',
          },
          fontFamily: {
            'montserrat': ['Montserrat','Roboto'],
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .bg-umich-blue { background-color: #00274c; }
      .bg-umich-maize { background-color: #ffcb05; }
      .bg-canvas-blue { background-color: #0374B5; }
      .border-umich-blue { border-color: #00274c; }
      .border-umich-maize { border-color: #ffcb05; }
      .border-canvas-blue { border-color: #0374B5; }
      .text-umich-blue { color: #00274c; }
      .text-umich-maize { color: #ffcb05; }
      .text-canvas-blue { color: #0374B5; }
      .hover\:bg-blue-900:hover { background-color: #1e3a8a; }
      .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
      .font-montserrat { font-family: 'Montserrat','Roboto'; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-montserrat">
  <header class="bg-umich-blue text-white py-6 shadow-md border-b-4 border-umich-maize">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl font-bold">ME240 Canvas Page Generator</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Upload Section -->
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
      <section class="pb-8">
        <h2 class="text-2xl font-bold text-umich-blue mb-4">Upload Your Excel File</h2>
        <p class="mb-4">Please upload your Excel file containing a course schedule to generate the Canvas pages.</p>

        <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 text-center hover:border-canvas-blue hover:bg-blue-50 transition-colors duration-300">
          <label class="block text-gray-700 font-medium mb-4">Drag &amp; drop your file here or</label>
          <label class="bg-canvas-blue text-white py-3 px-5 rounded-md cursor-pointer hover:bg-blue-700 inline-block transition-colors duration-300">
            <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden">
            Choose File
          </label>
          <p id="file-name" class="mt-4 text-gray-500 italic">No file selected</p>
        </div>

        <div class="mt-4 flex justify-center gap-4">
          <button id="generate-btn" disabled class="bg-umich-blue text-white py-3 px-6 rounded-md font-medium hover:bg-blue-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Generate Pages
          </button>
          <button id="download-all-btn" disabled class="bg-umich-blue text-white py-3 px-6 rounded-md font-medium hover:bg-blue-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Download All
          </button>
        </div>

        <div id="loading" class="hidden mt-6 text-center">
          <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="mt-2 text-gray-600">Processing your file. Please wait...</p>
        </div>
      </section>
    </div>

    <!-- Generated Pages Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <section>
        <h2 class="text-2xl font-bold text-umich-blue mb-4">Your Generated Pages</h2>
        <div id="no-pages" class="bg-gray-50 p-6 rounded-lg text-gray-500 text-center italic">
          No pages generated yet. Upload a file and click "Generate Pages".
        </div>
        <div id="page-tabs" class="hidden mb-4 border-b border-gray-200"></div>
        <div id="pages-container" class="hidden px-8">
          <!-- Pages will be inserted here -->
        </div>
        <div id="download-pages-container" class="hidden mt-6 flex justify-center">
          <!-- Download buttons will be inserted here -->
        </div>
      </section>
    </div>
  </main>

  <footer class="text-center py-4 text-gray-500 text-sm">
    <p>Â© 2025 University of Michigan ME240 Canvas Page Generator</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('excel-file');
      const fileName = document.getElementById('file-name');
      const generateBtn = document.getElementById('generate-btn');
      const downloadAllBtn = document.getElementById('download-all-btn');
      const loading = document.getElementById('loading');
      const dropArea = document.getElementById('drop-area');
      const noPages = document.getElementById('no-pages');
      const pageTabs = document.getElementById('page-tabs');
      const pagesContainer = document.getElementById('pages-container');
      const downloadPagesContainer = document.getElementById('download-pages-container');

      // File selection
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          fileName.textContent = fileInput.files[0].name;
          generateBtn.disabled = false;
        } else {
          fileName.textContent = 'No file selected';
          generateBtn.disabled = true;
        }
      });

      // Drag & drop
      ['dragenter','dragover','dragleave','drop'].forEach(e =>
        dropArea.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); })
      );
      ['dragenter','dragover'].forEach(e =>
        dropArea.addEventListener(e, () => dropArea.classList.add('border-canvas-blue','bg-blue-50'))
      );
      ['dragleave','drop'].forEach(e =>
        dropArea.addEventListener(e, () => dropArea.classList.remove('border-canvas-blue','bg-blue-50'))
      );
      dropArea.addEventListener('drop', ev => {
        const dt = ev.dataTransfer;
        if (dt.files.length) {
          fileInput.files = dt.files;
          fileName.textContent = dt.files[0].name;
          generateBtn.disabled = false;
        }
      });

      // Download All button click handler
      downloadAllBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/download');
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to download files');
          }
          
          // Create a blob from the response and trigger download
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'all_html_files.zip';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (err) {
          alert(`Error downloading files: ${err.message}`);
        }
      });

      // Generate & upload
      generateBtn.addEventListener('click', async () => {
        if (!fileInput.files[0]) return;

        loading.classList.remove('hidden');
        noPages.classList.add('hidden');
        pageTabs.classList.add('hidden');
        pagesContainer.classList.add('hidden');
        downloadPagesContainer.classList.add('hidden');
        downloadAllBtn.disabled = true; // Disable download button during generation

        const form = new FormData();
        form.append('file', fileInput.files[0], fileInput.files[0].name);

        try {
          // 1) upload to /upload
          const uploadRes = await fetch('/upload', { method: 'POST', body: form });
          if (!uploadRes.ok) throw await uploadRes.json();
          const { url } = await uploadRes.json();

          // 2) generate pages on server
          const genRes = await fetch(`/generate?path=${encodeURIComponent(url)}`);
          if (!genRes.ok) throw await genRes.json();
          const pageHtmlFiles = await genRes.json();

          displayPages(pageHtmlFiles);
          // Enable download button after successful generation
          downloadAllBtn.disabled = false;
        } catch (err) {
          displayError(err);
        } finally {
          // hide spinner
          loading.classList.add('hidden');
          // clear out previous file info
          fileInput.value = '';
          fileName.textContent = 'No file selected';
          generateBtn.disabled = true;
          // leave drop-area visible for a new upload
        }
      });

      function displayPages(pageHtmlFiles) {
        if (!pageHtmlFiles || !pageHtmlFiles.length) {
          noPages.classList.remove('hidden');
          noPages.textContent = 'No pages found. Please check your file and try again.';
          return;
        }

        pageTabs.innerHTML = '';
        pagesContainer.innerHTML = '';
        downloadPagesContainer.innerHTML = '';

        pageHtmlFiles.forEach((page, i) => {
          // tab
          const tab = document.createElement('button');
          tab.textContent = page.name;
          tab.className = 'px-4 py-2 font-medium focus:outline-none';
          if (i === 0) tab.classList.add('border-b-2','border-canvas-blue','text-canvas-blue');
          else tab.classList.add('text-gray-500','hover:text-gray-700');
          tab.onclick = () => {
            document.querySelectorAll('#page-tabs button').forEach(b => {
              b.classList.toggle('border-b-2', false);
              b.classList.toggle('text-canvas-blue', false);
              b.classList.toggle('text-gray-500', true);
            });
            tab.classList.remove('text-gray-500');
            tab.classList.add('border-b-2','border-canvas-blue','text-canvas-blue');

            document.querySelectorAll('.page-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`page-content-${i}`).classList.remove('hidden');

            // Show only the download button for the selected week
            document.querySelectorAll('.download-button').forEach(btn => btn.classList.add('hidden'));
            document.getElementById(`download-btn-${i}`).classList.remove('hidden');
          };
          pageTabs.appendChild(tab);

          // content iframe with increased padding
          const contentDiv = document.createElement('div');
          contentDiv.id = `page-content-${i}`;
          contentDiv.className = 'page-content bg-white rounded-lg border border-gray-200 p-4';
          if (i !== 0) contentDiv.classList.add('hidden');

          const iframe = document.createElement('iframe');
          iframe.className = 'w-full h-[800px] border-0'; // Made iframe taller
          iframe.title = page.name;
          contentDiv.appendChild(iframe);
          pagesContainer.appendChild(contentDiv);

          // write HTML
          setTimeout(() => {
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(page.html);
            doc.close();
          });

          // download button (only visible for the first tab initially)
          const downloadBtn = document.createElement('button');
          downloadBtn.id = `download-btn-${i}`;
          downloadBtn.textContent = `Download ${page.name}`;
          downloadBtn.className = 'download-button bg-umich-blue text-white py-3 px-8 rounded-md hover:bg-blue-900 transition-colors duration-300 shadow-sm mx-auto';
          if (i !== 0) downloadBtn.classList.add('hidden');
          
          downloadBtn.onclick = () => {
            const blob = new Blob([page.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${page.name.replace(/\s+/g,'_')}.html`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
          };
          
          downloadPagesContainer.appendChild(downloadBtn);
        });

        noPages.classList.add('hidden');
        pageTabs.classList.remove('hidden');
        pagesContainer.classList.remove('hidden');
        downloadPagesContainer.classList.remove('hidden');
      }

      function displayError(error) {
        noPages.classList.remove('hidden');
        noPages.innerHTML = `<span class="text-red-600">Error: ${error.detail || error}</span>`;
        pageTabs.classList.add('hidden');
        pagesContainer.classList.add('hidden');
        downloadPagesContainer.classList.add('hidden');
        downloadAllBtn.disabled = true; // Disable download button on error
      }
    });
  </script>
</body>
</html>
