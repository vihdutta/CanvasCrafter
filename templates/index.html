<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CanvasCrafter</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Montserrat Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"/>
  <script>
    tailwindConfig = {
      theme: {
        extend: {
          colors: {
            'umich-blue': '#00274c',
            'umich-maize': '#ffcb05',
            'canvas-blue': '#0374B5',
          },
          fontFamily: {
            'montserrat': ['Montserrat','Roboto'],
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .bg-umich-blue { background-color: #00274c; }
      .bg-umich-maize { background-color: #ffcb05; }
      .bg-canvas-blue { background-color: #0374B5; }
      .border-umich-blue { border-color: #00274c; }
      .border-umich-maize { border-color: #ffcb05; }
      .border-canvas-blue { border-color: #0374B5; }
      .text-umich-blue { color: #00274c; }
      .text-umich-maize { color: #ffcb05; }
      .text-canvas-blue { color: #0374B5; }
      .hover\:bg-blue-900:hover { background-color: #1e3a8a; }
      .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
      .font-montserrat { font-family: 'Montserrat','Roboto'; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-montserrat">
  <header class="bg-umich-blue text-white py-6 shadow-md border-b-4 border-umich-maize">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl font-bold">ME240 Canvas Page Generator</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Upload Section -->
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
      <section class="pb-8">
        <h2 class="text-2xl font-bold text-umich-blue mb-4 text-center">Upload Your Excel File</h2>
        <p class="mb-4">Please upload your Excel file containing a course schedule to generate the Canvas pages.</p>

        <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 text-center hover:border-canvas-blue hover:bg-blue-50 transition-colors duration-300">
          <label class="block text-gray-700 font-medium mb-4">Drag &amp; drop your file here or</label>
          <label class="bg-canvas-blue text-white py-3 px-5 rounded-md cursor-pointer hover:bg-blue-700 inline-block transition-colors duration-300">
            <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden">
            Choose File
          </label>
          <p id="file-name" class="mt-4 text-gray-500 italic">No file selected</p>
        </div>

        <div class="mt-4 flex justify-center gap-4">
          <button id="generate-btn" disabled class="bg-umich-blue text-white py-3 px-6 rounded-md font-medium hover:bg-blue-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Generate Pages
          </button>
          <button id="download-all-btn" disabled class="bg-umich-blue text-white py-3 px-6 rounded-md font-medium hover:bg-blue-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Download All
          </button>
          <button id="upload-canvas-btn" disabled class="bg-red-600 text-white py-3 px-6 rounded-md font-medium hover:bg-red-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Upload All to Canvas
          </button>

        </div>

        <!-- Success/Error messages for Canvas upload -->
        <div id="canvas-upload-message" class="hidden mt-4">
          <div id="canvas-upload-progress" class="hidden mb-4">
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-blue-800 font-medium">Uploading to Canvas...</span>
                <span id="upload-progress-text" class="text-blue-600 text-sm">0/0</span>
              </div>
              <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
          </div>
          
          <div id="canvas-notifications" class="space-y-2 max-h-64 overflow-y-auto">
            <!-- Real-time notifications will appear here -->
          </div>
          
          <div id="canvas-success" class="hidden p-3 bg-green-100 border border-green-400 text-green-700 rounded-md">
            ✓ Successfully uploaded all items to Canvas!
          </div>
          <div id="canvas-error" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-md">
            <span id="canvas-error-text">Failed to upload items to Canvas.</span>
          </div>
        </div>



        <div id="loading" class="hidden mt-6 text-center">
          <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="mt-2 text-gray-600">Processing your file. Please wait...</p>
        </div>
      </section>
    </div>

    <!-- Generated Pages Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <section>
        <h2 class="text-2xl font-bold text-umich-blue mb-4 text-center">Your Generated Pages</h2>
        <div id="no-pages" class="bg-gray-50 p-6 rounded-lg text-gray-500 text-center italic">
          No pages generated yet. Upload a file and click "Generate Pages".
        </div>
        <div id="page-tabs" class="hidden mb-4 border-b border-gray-200"></div>
        <div id="pages-container" class="hidden px-8">
          <!-- Pages will be inserted here -->
        </div>
        <div id="download-pages-container" class="hidden mt-6 flex justify-center">
          <!-- Download buttons will be inserted here -->
        </div>
      </section>
    </div>

    <!-- Course ID Configuration Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
      <section>
        <h2 class="text-2xl font-bold text-umich-blue mb-4 text-center">Canvas Configuration</h2>
        <div class="max-w-md mx-auto space-y-4">
          <!-- Course ID Input -->
          <div>
            <label for="course-id-input" class="block text-sm font-medium text-gray-700 mb-2">
              Canvas Course ID
            </label>
            <div class="flex gap-2">
              <input
                type="text"
                id="course-id-input"
                placeholder="Enter your Canvas course ID"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-umich-blue focus:border-transparent"
              />
              <button
                id="course-id-save"
                class="px-4 py-2 bg-umich-blue text-white rounded-md hover:bg-blue-900 transition-colors duration-300 font-medium"
              >
                Save
              </button>
            </div>
            <div id="course-id-status" class="text-sm text-gray-600 mt-1">
              Loading course ID...
            </div>
          </div>
          
          <!-- Access Token Input -->
          <div>
            <label for="access-token-input" class="block text-sm font-medium text-gray-700 mb-2">
              Canvas API Access Token
            </label>
            <div class="flex gap-2">
              <input
                type="password"
                id="access-token-input"
                placeholder="Enter your Canvas API access token"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-umich-blue focus:border-transparent"
              />
              <button
                id="access-token-save"
                class="px-4 py-2 bg-umich-blue text-white rounded-md hover:bg-blue-900 transition-colors duration-300 font-medium"
              >
                Save
              </button>
            </div>
            <div id="access-token-status" class="text-sm text-gray-600 mt-1">
              Loading access token...
            </div>
          </div>
          
          <p class="text-xs text-gray-500 mt-2">
            These credentials are used for Canvas operations and will be stored securely in your browser.
          </p>
        </div>
      </section>
    </div>
  </main>

  <footer class="text-center py-4 text-gray-500 text-sm">
    <p>© 2025 University of Michigan ME240 Canvas Page Generator</p>
  </footer>

  <script>
    // Cookie utility functions (defined globally)
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('excel-file');
      const fileName = document.getElementById('file-name');
      const generateBtn = document.getElementById('generate-btn');
      const downloadAllBtn = document.getElementById('download-all-btn');
      const uploadCanvasBtn = document.getElementById('upload-canvas-btn');

      const loading = document.getElementById('loading');
      const dropArea = document.getElementById('drop-area');
      const noPages = document.getElementById('no-pages');
      const pageTabs = document.getElementById('page-tabs');
      const pagesContainer = document.getElementById('pages-container');
      const downloadPagesContainer = document.getElementById('download-pages-container');
      const canvasUploadMessage = document.getElementById('canvas-upload-message');
      const canvasSuccess = document.getElementById('canvas-success');
      const canvasError = document.getElementById('canvas-error');
      const canvasErrorText = document.getElementById('canvas-error-text');


      // File selection
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          fileName.textContent = fileInput.files[0].name;
          generateBtn.disabled = false;
        } else {
          fileName.textContent = 'No file selected';
          generateBtn.disabled = true;
        }
      });

      // Drag & drop
      ['dragenter','dragover','dragleave','drop'].forEach(e =>
        dropArea.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); })
      );
      ['dragenter','dragover'].forEach(e =>
        dropArea.addEventListener(e, () => dropArea.classList.add('border-canvas-blue','bg-blue-50'))
      );
      ['dragleave','drop'].forEach(e =>
        dropArea.addEventListener(e, () => dropArea.classList.remove('border-canvas-blue','bg-blue-50'))
      );
      dropArea.addEventListener('drop', ev => {
        const dt = ev.dataTransfer;
        if (dt.files.length) {
          fileInput.files = dt.files;
          fileName.textContent = dt.files[0].name;
          generateBtn.disabled = false;
        }
      });

      // Download All button click handler
      downloadAllBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/download');
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to download files');
          }
          
          // Create a blob from the response and trigger download
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'all_html_files.zip';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (err) {
          alert(`Error downloading files: ${err.message}`);
        }
      });

      // Generate & upload
      generateBtn.addEventListener('click', async () => {
        if (!fileInput.files[0]) return;

        // Check if course ID and access token are set
        const courseId = getCookie('course_id');
        const accessToken = getCookie('access_token');
        if (!courseId || !accessToken) {
          alert('Please set both Course ID and Access Token in the Canvas Configuration section below before generating pages.');
          return;
        }

        loading.classList.remove('hidden');
        noPages.classList.add('hidden');
        pageTabs.classList.add('hidden');
        pagesContainer.classList.add('hidden');
        downloadPagesContainer.classList.add('hidden');
        downloadAllBtn.disabled = true; // Disable download button during generation
        uploadCanvasBtn.disabled = true; // Disable upload to canvas button during generation


        const form = new FormData();
        form.append('file', fileInput.files[0], fileInput.files[0].name);

        try {
          // 1) upload to /upload
          const uploadRes = await fetch('/upload', { method: 'POST', body: form });
          if (!uploadRes.ok) throw await uploadRes.json();
          const { url } = await uploadRes.json();

          // 2) generate pages on server
          const genRes = await fetch(`/generate?path=${encodeURIComponent(url)}`);
          if (!genRes.ok) throw await genRes.json();
          const pageHtmlFiles = await genRes.json();

          displayPages(pageHtmlFiles);
          // Enable download button after successful generation
          downloadAllBtn.disabled = false;
          // Enable upload to canvas button after successful generation
          uploadCanvasBtn.disabled = false;
        } catch (err) {
          // Check if it's a configuration error
          if (err.detail && (err.detail.includes('Course ID') || err.detail.includes('Access Token'))) {
            displayError({detail: 'Course ID and Access Token are required. Please set them in the Canvas Configuration section below.'});
          } else {
            displayError(err);
          }
        } finally {
          // hide spinner
          loading.classList.add('hidden');
          // clear out previous file info
          fileInput.value = '';
          fileName.textContent = 'No file selected';
          generateBtn.disabled = true;
          // leave drop-area visible for a new upload
        }
      });

      function displayPages(pageHtmlFiles) {
        if (!pageHtmlFiles || !pageHtmlFiles.length) {
          noPages.classList.remove('hidden');
          noPages.textContent = 'No pages found. Please check your file and try again.';
          return;
        }

        pageTabs.innerHTML = '';
        pagesContainer.innerHTML = '';
        downloadPagesContainer.innerHTML = '';

        // Separate weekly pages and homework files
        const weeklyPages = pageHtmlFiles.filter(page => page.type === 'weekly');
        const homeworkPages = pageHtmlFiles.filter(page => page.type === 'homework');

        // Combine for display (weekly first, then homework)
        const allPages = [...weeklyPages, ...homeworkPages];

        allPages.forEach((page, i) => {
          // tab
          const tab = document.createElement('button');
          tab.textContent = page.name;
          tab.className = 'px-4 py-2 font-medium focus:outline-none';
          if (page.type === 'homework') {
            tab.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
          }
          if (i === 0) tab.classList.add('border-b-2','border-canvas-blue','text-canvas-blue');
          else tab.classList.add('text-gray-500','hover:text-gray-700');
          tab.onclick = () => {
            document.querySelectorAll('#page-tabs button').forEach(b => {
              b.classList.toggle('border-b-2', false);
              b.classList.toggle('text-canvas-blue', false);
              b.classList.toggle('text-gray-500', true);
            });
            tab.classList.remove('text-gray-500');
            tab.classList.add('border-b-2','border-canvas-blue','text-canvas-blue');

            document.querySelectorAll('.page-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`page-content-${i}`).classList.remove('hidden');

            // Show only the download button for the selected week
            document.querySelectorAll('.download-button').forEach(btn => btn.classList.add('hidden'));
            document.getElementById(`download-btn-${i}`).classList.remove('hidden');
          };
          pageTabs.appendChild(tab);

          // content iframe with increased padding
          const contentDiv = document.createElement('div');
          contentDiv.id = `page-content-${i}`;
          contentDiv.className = 'page-content bg-white rounded-lg border border-gray-200 p-4';
          if (i !== 0) contentDiv.classList.add('hidden');

          const iframe = document.createElement('iframe');
          iframe.className = 'w-full h-[800px] border-0'; // Made iframe taller
          iframe.title = page.name;
          contentDiv.appendChild(iframe);
          pagesContainer.appendChild(contentDiv);

          // write HTML
          setTimeout(() => {
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(page.html);
            doc.close();
          });

          // download button (only visible for the first tab initially)
          const downloadBtn = document.createElement('button');
          downloadBtn.id = `download-btn-${i}`;
          downloadBtn.textContent = `Download ${page.name}`;
          downloadBtn.className = 'download-button bg-umich-blue text-white py-3 px-8 rounded-md hover:bg-blue-900 transition-colors duration-300 shadow-sm mx-auto';
          if (i !== 0) downloadBtn.classList.add('hidden');
          
          downloadBtn.onclick = () => {
            const blob = new Blob([page.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${page.name.replace(/\s+/g,'_')}.html`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
          };
          
          downloadPagesContainer.appendChild(downloadBtn);
        });

        noPages.classList.add('hidden');
        pageTabs.classList.remove('hidden');
        pagesContainer.classList.remove('hidden');
        downloadPagesContainer.classList.remove('hidden');
        
        // Enable buttons after successful generation
        downloadAllBtn.disabled = false;
        uploadCanvasBtn.disabled = false;
        

      }

      function displayError(error) {
        noPages.classList.remove('hidden');
        noPages.innerHTML = `<span class="text-red-600">Error: ${error.detail || error}</span>`;
        pageTabs.classList.add('hidden');
        pagesContainer.classList.add('hidden');
        downloadPagesContainer.classList.add('hidden');
        downloadAllBtn.disabled = true; // Disable download button on error
        uploadCanvasBtn.disabled = true; // Disable upload to canvas button on error

      }

      // Upload to Canvas button click handler
      uploadCanvasBtn.addEventListener('click', async () => {
        try {
          // Show progress section and hide previous messages
          canvasUploadMessage.classList.remove('hidden');
          document.getElementById('canvas-upload-progress').classList.remove('hidden');
          document.getElementById('canvas-notifications').innerHTML = '';
          canvasSuccess.classList.add('hidden');
          canvasError.classList.add('hidden');
          
          // Disable the button during upload
          uploadCanvasBtn.disabled = true;
          uploadCanvasBtn.textContent = 'Uploading...';
          
          // Create EventSource for Server-Sent Events
          const eventSource = new EventSource('/upload-to-canvas');
          
          eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            switch(data.type) {
              case 'start':
                updateProgress(0, data.total);
                addNotification('info', `Starting upload of ${data.total} items to Canvas...`);
                break;
                
              case 'success':
                updateProgress(data.current, data.total);
                const itemType = data.item_type === 'homework' ? 'assignment' : 'page';
                addNotification('success', `✓ Successfully uploaded ${itemType} "${data.title}"`);
                break;
                
              case 'error':
                const failedItemType = data.item_type === 'homework' ? 'assignment' : 'page';
                addNotification('error', `✗ Failed to upload ${failedItemType} "${data.title}": ${data.error}`);
                break;
                
              case 'complete':
                eventSource.close();
                document.getElementById('canvas-upload-progress').classList.add('hidden');
                
                if (data.success_count === data.total) {
                  canvasSuccess.classList.remove('hidden');
                  addNotification('success', `🎉 All ${data.success_count} items uploaded successfully to Canvas!`);
                } else {
                  canvasError.classList.remove('hidden');
                  canvasErrorText.textContent = `Uploaded ${data.success_count} out of ${data.total} items to Canvas. Some uploads failed.`;
                }
                
                // Re-enable button
                uploadCanvasBtn.disabled = false;
                uploadCanvasBtn.textContent = 'Upload All to Canvas';
                break;
            }
          };
          
          eventSource.onerror = function(event) {
            eventSource.close();
            document.getElementById('canvas-upload-progress').classList.add('hidden');
            canvasError.classList.remove('hidden');
            canvasErrorText.textContent = 'Connection error occurred during upload.';
            
            // Re-enable button
            uploadCanvasBtn.disabled = false;
            uploadCanvasBtn.textContent = 'Upload All to Canvas';
          };
          
        } catch (err) {
          canvasError.classList.remove('hidden');
          canvasErrorText.textContent = `Error: ${err.message}`;
          
          // Re-enable button
          uploadCanvasBtn.disabled = false;
          uploadCanvasBtn.textContent = 'Upload All to Canvas';
        }
      });

      function updateProgress(current, total) {
        const progressBar = document.getElementById('upload-progress-bar');
        const progressText = document.getElementById('upload-progress-text');
        
        const percentage = total > 0 ? (current / total) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${current}/${total}`;
      }

      function addNotification(type, message) {
        const notificationsContainer = document.getElementById('canvas-notifications');
        const notification = document.createElement('div');
        
        let bgColor, borderColor, textColor;
        switch(type) {
          case 'success':
            bgColor = 'bg-green-50';
            borderColor = 'border-green-200';
            textColor = 'text-green-800';
            break;
          case 'error':
            bgColor = 'bg-red-50';
            borderColor = 'border-red-200';
            textColor = 'text-red-800';
            break;
          case 'info':
          default:
            bgColor = 'bg-blue-50';
            borderColor = 'border-blue-200';
            textColor = 'text-blue-800';
            break;
        }
        
        notification.className = `p-2 ${bgColor} border ${borderColor} ${textColor} rounded text-sm`;
        notification.textContent = message;
        
        notificationsContainer.appendChild(notification);
        
        // Auto-scroll to bottom
        notificationsContainer.scrollTop = notificationsContainer.scrollHeight;
      }
      // Canvas configuration management
      const courseIdInput = document.getElementById('course-id-input');
      const courseIdSaveBtn = document.getElementById('course-id-save');
      const courseIdStatus = document.getElementById('course-id-status');
      const accessTokenInput = document.getElementById('access-token-input');
      const accessTokenSaveBtn = document.getElementById('access-token-save');
      const accessTokenStatus = document.getElementById('access-token-status');

      // Load course ID from cookie on page load
      function loadCourseId() {
        const courseId = getCookie('course_id');
        if (courseId) {
          courseIdInput.value = courseId;
          courseIdStatus.textContent = `Current Course ID: ${courseId}`;
          courseIdStatus.className = 'text-sm text-green-600 mt-1';
        } else {
          courseIdStatus.textContent = 'No Course ID set';
          courseIdStatus.className = 'text-sm text-red-600 mt-1';
        }
      }

      // Load access token from cookie on page load
      function loadAccessToken() {
        const accessToken = getCookie('access_token');
        if (accessToken) {
          accessTokenInput.value = accessToken;
          accessTokenStatus.textContent = `Access token saved (${accessToken.substring(0, 8)}...)`;
          accessTokenStatus.className = 'text-sm text-green-600 mt-1';
        } else {
          accessTokenStatus.textContent = 'No Access Token set';
          accessTokenStatus.className = 'text-sm text-red-600 mt-1';
        }
      }

      // Save course ID to cookie
      courseIdSaveBtn.addEventListener('click', () => {
        const courseId = courseIdInput.value.trim();
        if (courseId) {
          setCookie('course_id', courseId, 365 * 10);
          courseIdStatus.textContent = `Course ID saved: ${courseId}`;
          courseIdStatus.className = 'text-sm text-green-600 mt-1';
        } else {
          courseIdStatus.textContent = 'Please enter a valid Course ID';
          courseIdStatus.className = 'text-sm text-red-600 mt-1';
        }
      });

      // Save access token to cookie
      accessTokenSaveBtn.addEventListener('click', () => {
        const accessToken = accessTokenInput.value.trim();
        if (accessToken) {
          setCookie('access_token', accessToken, 365 * 10);
          accessTokenStatus.textContent = `Access token saved (${accessToken.substring(0, 8)}...)`;
          accessTokenStatus.className = 'text-sm text-green-600 mt-1';
        } else {
          accessTokenStatus.textContent = 'Please enter a valid Access Token';
          accessTokenStatus.className = 'text-sm text-red-600 mt-1';
        }
      });

      loadCourseId();
      loadAccessToken();
    });
  </script>
</body>
</html>
